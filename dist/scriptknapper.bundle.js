!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.scriptknapper=e():t.scriptknapper=e()}(this,(function(){return(()=>{"use strict";var t={d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{buildTemplateJSON:()=>u,prepareTemplateString:()=>h,scriptKnapperMain:()=>f});const r=function(t,e="",r=""){let n="TRANSPILATION ERROR\n\nError while transpiling script from provided JSON:\n\n";return n+=t+"\n\n",""!==e&&(n+="Error occurred in the following template: "+e,n+=""===r?"\n\n":"\n"),""!==r&&(n+="Error occurred with the following markup data: "+r,n+="\n\n"),n+="Please correct these issues with the provided JSON, and then try again.",n},n=function(t,e){try{if(!t.hasOwnProperty("template"))throw"The given template call has not been given a template property.";let r=t.template,n=e.filter((t=>t.name===r));if(0===n.length)throw"The given template name ("+r+") is not recognised.";if(n.length>1)throw"The given template name ("+r+") has more than one match.";if(t.hasOwnProperty("data")&&!Array.isArray(t.data))throw"The provided data to the "+t.template+" template is not in an array."}catch(t){return r("Encountered a problem parsing the provided markup JSON: "+t)}return""},o=function(t){let e={};for(let r=0;r<t.length;r++)e={...t[r],...e};return e},a=function(t,e="{",r="}"){if(!t.startsWith(e))return-1;let n=0,o=0;for(;o<t.length;){if(t.substr(o,e.length)==e)n++;else if(t.substr(o,r.length)==r&&(n--,0===n))return o+r.length;o++}return-1},i=function(t,e){let r,n="ScriptKnapper encountered an issue when attempting to add data from a template to the data object: ",i=e;for(;i.includes("{+");){r=i.indexOf("{+");let e,l=a(i.substring(r,i.length),"{+","+}");if(l<0)throw new Error(n+"Data addition tag was not properly closed.");try{e=JSON.parse("{"+i.substring(r+2,r+l-2)+"}")}catch(t){throw new Error(n+t)}t=o([e,t]),i=i.substring(r+l,i.length)}return t},l=function(t){let e,r;for(;t.includes("{+");){if(e=t.indexOf("{+"),r=a(t.substring(e,t.length),"{+","+}"),r<0)throw new Error("ScriptKnapper encountered an issue when attempting to add data from a template to the data object: Data addition tag was not properly closed.");t=t.substring(0,e)+t.substring(e+r)}return t},p=function(t,e,n){let o,i,l=n,p=0;for(;l.substring(p).includes("{:");){i=p+l.substring(p).indexOf("{:");try{let e;if(o="ScriptKnapper encountered an issue when attempting to resolve a call to the requested data: ","{"===l.charAt(i-1)){if(e=a(l.substring(i-1),"{{:",":}}"),-1===e)throw"Encountered an incorrectly formatted call to a template.";p=i+e}else{if(e=a(l.substring(i),"{:",":}"),-1===e)throw"Encountered an incomplete call to a data property.";let r=l.substring(i+2,i+e-2).trim();if(!t.hasOwnProperty(r))throw"Encountered a call to a property ("+r+") that hasn't been passed to the template.";if("string"!=typeof t[r])throw"Encountered a call to a property ("+r+") that did not contain a string.";l=l.substring(0,i)+t[r]+l.substring(i+e)}}catch(n){throw new Error(r(o+n,e,JSON.stringify(t)))}}return l},d=function(t,e,n){let i,l,p="Error handling embedded template call: ";for(;(i=t.indexOf("{{:"))>-1;){if(l=a(t.substring(i),"{{:",":}}"),-1===l)throw new Error(r(p+"Embedded template object is invalid or incomplete.","Unable to determine the template called within an embedded template call.",JSON.stringify(e)));{let a;try{a=JSON.parse("{"+t.substring(i+3,i+l-3)+"}")}catch(t){throw new Error(r(p+"Embedded template object is invalid.","Unable to determine the template called within an embedded template call.",JSON.stringify(e)))}let d={template:a.template,data:[]};for(let t=0;t<a.data.length;t++)d.data[t]=o([a.data[t],e]);let s=m([d],n);t=t.substring(0,i)+s+t.substring(i+l)}}return t},s=function(t,e,n){let o="",a="No data JSON is available for this exception.",s="Error when attempting to feed data into a template: ";try{for(let r=0;r<e.data.length;r++){a=JSON.stringify([e.data[r]]);let m=i(e.data[r],t.template);e.data[r]=m;let c=l(t.template),f=p(e.data[r],t.name,c);s="Encountered a problem parsing a call to an embedded template: ",o+=d(f,e.data[r],n)}}catch(e){throw Error(r(s+e,t.name,a))}return o},m=function(t,e){let o,a,i="",l="";try{for(let r=0;r<t.length;r++){let p=n(t[r],e);if(""!==p)throw p;a=e.filter((e=>e.name===t[r].template))[0],l=a.name,o=t[r].data,t[r].hasOwnProperty("data")&&0!==t[r].data.length||(t[r].data=[{}]),i+=s(a,t[r],e)}}catch(t){throw new Error(r("Error when resolving a markup object: "+t,l,JSON.stringify(o)))}return i},c=function(t,e){let r;for(let n=0;n<e.length;n++){const o=e[n].from.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");r=new RegExp(o,"gi"),t=t.replace(r,e[n].to)}return t},f=function(t,e){let n,o,a,i="";try{n="Encountered a problem parsing the provided template JSON: ",a=JSON.parse(e),n="Encountered a problem parsing the provided markup JSON: ",o=JSON.parse(t)}catch(t){throw new Error(r(n+t,"No template name is available for this error.","No data JSON is available for this error."))}let l=m(o,a);return i=c(l,[{from:"@ohb:",to:"{:"},{from:"@chb:",to:":}"},{from:"@odhb:",to:"{{:"},{from:"@cdhb:",to:":}}"},{from:"@ohb+",to:"{+"},{from:"@chb+",to:"+}"}]),i},h=function(t,e="none",r=!1,n=!1){let o=[];return"none"!==e&&("remove"===e?o.push({from:"\t",to:""},{from:"\v",to:""},{from:"\r",to:""},{from:"\n",to:""}):"spaceReplace"===e?o.push({from:"\t",to:" "},{from:"\v",to:" "},{from:"\r",to:" "},{from:"\n",to:" "}):"escapeCodeReplace"===e&&o.push({from:"\t",to:String.raw`\t`},{from:"\v",to:String.raw`\v`},{from:"\r",to:String.raw`\r`},{from:"\n",to:String.raw`\n`})),r&&o.push({from:'"',to:String.raw`\"`}),n&&o.push({from:"{{:",to:"@odhb:"},{from:":}}",to:"@cdhb:"},{from:"{:",to:"@ohb:"},{from:":}",to:"@chb:"},{from:"{+",to:"@ohb+"},{from:"+}",to:"@chb+"}),c(t,o)},u=function(t,e=!1){let r="[";return t.forEach((t=>{let n=t.template;e||(n=c(n,[{from:"\t",to:String.raw`\t`},{from:"\v",to:String.raw`\v`},{from:"\r",to:String.raw`\r`},{from:"\n",to:String.raw`\n`},{from:'"',to:String.raw`\"`}])),"}"===r.charAt(r.length-1)&&(r+=","),r+='\n\t{ "name": "'+t.templateName+'", "template": "'+n+'" }'})),r+"\n]"};return e})()}));